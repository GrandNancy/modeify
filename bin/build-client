#!/usr/bin/env node

var env = process.argv[2] || process.env.NODE_ENV || 'development';

var build = require('component-builder');
var resolve = require('component-resolver');
var component = require('../component.json');
var fs = require('fs');
var htmlMinifier = require('html-minifier').minify;
var yml2js = require('js-yaml').load;
var marked = require('marked');
var mkdir = require('mkdirp');
var myth = require('myth');
var path = require('path');
var sqwish = require('sqwish');
var uglify = require('uglify-js');
var zlib = require('zlib');

// Convert the YAML config

var config = yml2js(fs.readFileSync(__dirname + '/../deployment/config.yaml', 'utf8'));

// Set the rest of the public config.

config.env = env;
for (var key in config.environments[env])
  config[key] = config.environments[env][key] || config[key] || '';

// remove unused data

delete config.environments;

// Get the about page & terms and conditions

var aboutPage = marked(fs.readFileSync(__dirname + '/../deployment/about.md', 'utf8'));
var termsPage = marked(fs.readFileSync(__dirname + '/../deployment/terms.md', 'utf8'));

// Get the messages

var messages = yml2js(fs.readFileSync(__dirname + '/../deployment/messages.yaml', 'utf8'));

// Build all

component.locals.forEach(bundle);

// HTML Minifier Options

var htmlMinifierOptions = {
  collapseWhitespace: true,
  collapseBooleanAttributes: true,
  removeEmptyAttributes: true,
  removeOptionalTags: true
};

// Build.

function bundle(app) {
  // Build settings.

  var dest = 'assets/build/' + app;
  var development = env === 'development';

  // mkdirp

  mkdir.sync(__dirname + '/../' + dest);

  // Builder.

  resolve({
    paths: [
      'client'
    ],
    locals: [
      app
    ]
  }, {
    development: development,
    install: true,
    out: __dirname + '/../components',
    root: __dirname + '/..',
    verbose: true
  }, function(err, tree) {
    if (err) throw err;

    build
      .scripts(tree, {
        alias: development,
        sourceMap: development,
        sourceUrl: development
      })
      .use('json', build.plugins.json())
      .use('scripts', build.plugins.js())
      .use('templates', templates({
        development: development
      }))
      .end(function(err, str) {
        if (err) throw err;

        // Add global vars first
        var globalVars = {
          config: config,
          messages: messages,
          templates: {
            about: htmlMinifier(aboutPage, htmlMinifierOptions),
            terms: htmlMinifier(termsPage, htmlMinifierOptions)
          }
        };
        var js = 'window.modeify=' + JSON.stringify(globalVars, null, '\t')  + ';\n';

        js += build.scripts.require + '\n' + str + ';require("' + build.scripts.canonical(tree).canonical + '");\n';

        if (!development) {
          js = uglify.minify(js, { fromString: true }).code;
          js = zlib.gzipSync(js);
        }

        fs.writeFileSync(path.resolve(__dirname + '/../' + dest, 'build.js'), js);
      });

    build
      .styles(tree)
      .use('styles', build.plugins.css())
      .end(function(err, str) {
        if (err) throw err;
        var css = myth(str);
        css = css.replace(/\burl *\(([^)]+)\)/g, rewrite);

        if (!development) {
          css = sqwish.minify(css);
          css = zlib.gzipSync(css);
        }

        fs.writeFileSync(path.resolve(__dirname + '/../' + dest, 'build.css'), css);
      });
  });
}

function rewrite(_, url) {
  var orig = 'url("' + url + '")';
  if (isData(url)) return orig;
  return 'url("' + config.static_url + url + '")';
}

function isData(url) {
  return url.indexOf('data:') === 0;
}

function templates(options) {
  return function(file, done) {
    file.read(function (err, string) {
      if (err) return done(err);
      if (file.extension === 'md') string = marked(string);

      file.string = JSON.stringify(htmlMinifier(string, htmlMinifierOptions));
      file.define = true;
      done();
    });
  };
}
